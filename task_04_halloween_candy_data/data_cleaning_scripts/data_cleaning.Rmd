---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(janitor)
library(readxl)
library(assertr)
library(stringr)
library(here)
```
read in tables
```{r}
candy_2015 <- read_excel(here("raw_data/boing-boing-candy-2015.xlsx"))
candy_2016 <- read_excel(here("raw_data/boing-boing-candy-2016.xlsx"))
candy_2017 <- read_excel(here("raw_data/boing-boing-candy-2017.xlsx"))
```

clean names
```{r}
candy_2015 <- clean_names(candy_2015)
candy_2016 <- clean_names(candy_2016)
candy_2017 <- clean_names(candy_2017)
```

look at names
```{r}
# candy_2015 %>%
#   names()
# 
# candy_2016 %>% 
#   names()
# 
# candy_2017 %>% 
#   names()
```


```{r}
candy_2016 %>% 
  distinct(how_old_are_you)
```


--------------------------------------------------------------------------------
# 2015
rename columns
```{r}
candy_2015 <- candy_2015 %>% 
  rename(boxo_raisins = box_o_raisins,
         hersheys_kisses = hershey_s_kissables,
         licorice_yes_black = licorice)
```


find the outliers for age
```{r}
# candy_2015 %>% 
#   arrange(how_old_are_you) %>% 
#   distinct(how_old_are_you) %>% 
#   pull()
```


change outlier ages where appropriate
```{r}
candy_2015_ages <- candy_2015 %>% 
  mutate(how_old_are_you = str_remove_all(how_old_are_you, "[0-9][0-9][0-9]"),
         how_old_are_you = str_remove_all(how_old_are_you, "3.14%"),
         how_old_are_you = str_replace(how_old_are_you, ">39", "39"),
         how_old_are_you = str_replace(how_old_are_you, "７１＋", "71"),
         how_old_are_you = str_replace(how_old_are_you, "Good Lord!  I'm 43!", "43"))
```

```{r}
# candy_2015_ages %>%
#   arrange(how_old_are_you) %>%
#   distinct(how_old_are_you) %>%
#   pull()
```


pivot longer
```{r}
candy_2015_longer <- candy_2015_ages %>% 
  pivot_longer(c(4:96, 115),
               names_to = "candies",
               values_to = "rating")

candy_2015_longer
```


add year column
move new columns
select columns
rename columns
```{r}
candy_2015_clean <- candy_2015_longer %>% 
  mutate(year = 2015) %>% 
  relocate(c(candies:year), .after = timestamp) %>% 
  select(c(candies:are_you_going_actually_going_trick_or_treating_yourself)) %>% 
  rename(age = how_old_are_you,
         trick_or_treating = are_you_going_actually_going_trick_or_treating_yourself)
```



change age column to numeric
```{r}
candy_2015_clean <- candy_2015_clean %>% 
  mutate(age = str_extract_all(age, "^[0-9][0-9]")) %>% 
  mutate(age = as.numeric(age))
```


filter ages
```{r}
candy_2015_clean <- candy_2015_clean %>% 
  filter(age > 9,
         age < 100)
```

add countries
```{r}
candy_2015_clean <- candy_2015_clean %>% 
  mutate(country = "",
         country = na_if(country, ""),
         gender = "",
         gender = na_if(gender, ""))
```


```{r}
candies_2015 <- candy_2015_clean %>%
  arrange(candies) %>% 
  distinct(candies) %>% 
  pull()
```

```{r}
candy_2015_clean %>% 
  distinct(rating)
```

```{r}
candy_2015_clean %>% 
  distinct(trick_or_treating)
```

```{r}
candy_2015_clean %>% 
  distinct(age)
```



--------------------------------------------------------------------------------

# 2016

```{r}
candy_2016_longer <- candy_2016 %>% 
  pivot_longer(c(7:106),
               names_to = "candies",
               values_to = "rating")

candy_2016_longer
```

```{r}
candy_2016_clean <- candy_2016_longer %>% 
  mutate(year = 2016) %>% 
  relocate(c(candies:year), .after = timestamp) %>% 
  select(c(candies:which_country_do_you_live_in)) %>% 
  rename(age = how_old_are_you,
         trick_or_treating = are_you_going_actually_going_trick_or_treating_yourself,
         gender = your_gender,
         country = which_country_do_you_live_in)
```


```{r}
candy_2016_clean <- candy_2016_clean %>% 
    relocate(age, .after = year)

candy_2016_clean <- candy_2016_clean %>% 
  relocate(gender, .after = country)
```


```{r}
candy_2016_clean <- candy_2016_clean %>% 
  mutate(age = str_extract_all(age, "^[0-9][0-9]")) %>% 
  mutate(age = as.numeric(age))
```

```{r}
candy_2016_clean <- candy_2016_clean %>% 
  filter(age > 4,
         age < 100)
```

```{r}
candy_2016_clean <- candy_2016_clean %>% 
  mutate(country = str_to_title(country))
```




```{r}
candies_2016 <- candy_2016_clean %>% 
  arrange(candies) %>% 
  distinct(candies) %>% 
  pull()
```

```{r}
candy_2016_clean %>% 
  distinct(rating)
```

```{r}
candy_2016_clean %>% 
  distinct(gender)
```

```{r}
candy_2016_clean %>% 
  distinct(trick_or_treating)
```

```{r}
candy_2016_clean %>% 
  distinct(country)
```




--------------------------------------------------------------------------------
# 2017

```{r}
candy_2017 <- candy_2017 %>% 
  rename_with(~ gsub("^q[0-9]_", "", .x))

candy_2017 <- candy_2017 %>% 
  rename_with(~str_replace(., "^", "x"), .cols = starts_with("100"))

candy_2017 <- candy_2017 %>% 
  rename(anonymous_brown_globs_that_come_in_black_and_orange_wrappers = anonymous_brown_globs_that_come_in_black_and_orange_wrappers_a_k_a_mary_janes)
```

```{r}
candy_2017_longer <- candy_2017 %>% 
  pivot_longer(c(7:109),
               names_to = "candies",
               values_to = "rating")

candy_2017_longer
```

```{r}
candy_2017_clean <- candy_2017_longer %>% 
  mutate(year = 2017) %>% 
  relocate(c(candies:year), .after = internal_id) %>% 
  select(c(candies:country)) %>% 
  rename(trick_or_treating = going_out)
```

```{r}
candy_2017_clean <- candy_2017_clean %>% 
  relocate(age, .after = year)

candy_2017_clean <- candy_2017_clean %>% 
  relocate(gender, .after = country)
```

```{r}
candies_2017 <- candy_2017_clean %>%
  arrange(candies) %>% 
  distinct(candies) %>% 
  pull()
```



--------------------------------------------------------------------------------
# Find outliers in candies
```{r}
# Candies in 2015 that are not in 2016
candies_2015[!(candies_2015 %in% candies_2016)]
```

```{r}
# Candies in 2015 that are not in 2017
candies_2015[!(candies_2015 %in% candies_2017)]
```


```{r}
# Candies in 2016 that are not in 2015
candies_2016[!(candies_2016 %in% candies_2015)]
```

```{r}
# Candies in 2016 that are not in 2017
candies_2016[!(candies_2016 %in% candies_2017)]
```



```{r}
# Candies in 2017 that are not in 2015
candies_2017[!(candies_2017 %in% candies_2015)]
```

```{r}
# Candies in 2017 that are not in 2016
candies_2017[!(candies_2017 %in% candies_2016)]
```

